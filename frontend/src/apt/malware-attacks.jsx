import React, { useState, useEffect, useRef } from "react";
import { Layout } from "antd";
import AppHeader from "../components/Header";
import Sidebar from "../components/Sidebar";
import Tabs from "../components/Tabs";
import TerminalPanel from "../components/TerminalPanel";
import IPPanel from "../components/IPPanel";
import socket from "../components/socket";
import "../style.css";
import "../index.css";

const { Content, Sider, Footer } = Layout;

const API_BASE = "http://localhost:3001";

const MalwareAttacks = () => {
  const [targetIP, setTargetIP] = useState("");
  const [commandsList, setCommandsList] = useState([]);
  const [commandStr, setCommandStr] = useState("");
  const [loading, setLoading] = useState(false);
  const [progressIdx, setProgressIdx] = useState(-1);
  const timerRef = useRef(null);
  const mountedRef = useRef(true);
  const preferredKey = "malware";

  const tabItems = [
    {
      key: "port scans",
      label: "Port Scan",
      category: "APT Attacks",
      path: "/apt/port-scans",
    },
    {
      key: "brute forces",
      label: "Brute Force",
      category: "APT Attacks",
      path: "/apt/brute-forces",
    },
    {
      key: "ssh attacks",
      label: "SSH Attack",
      category: "APT Attacks",
      path: "/apt/ssh-attacks",
    },
    {
      key: "dos attacks",
      label: "DoS Attack",
      category: "APT Attacks",
      path: "/apt/dos-attacks",
    },
    {
      key: "malware attacks",
      label: "Malware Attack",
      category: "APT Attacks",
      path: "/apt/malware-attacks",
    },
    {
      key: "phishing attacks",
      label: "Phishing Attack",
      category: "APT Attacks",
      path: "/apt/phishing-attacks",
    },
    {
      key: "data exploitations",
      label: "Data Exploitation",
      category: "APT Attacks",
      path: "/apt/data-exploitations",
    },
    {
      key: "lateral movements",
      label: "Lateral Movement",
      category: "Internal Attacks",
      path: "/apt/lateral-movements",
    },
    {
      key: "covenant",
      label: "Covenant",
      category: "APT Attacks",
      path: "/apt/covenant",
    },
  ];

  useEffect(() => {
    mountedRef.current = true;
    return () => {
      mountedRef.current = false;
      if (timerRef.current) {
        clearTimeout(timerRef.current);
        timerRef.current = null;
      }
    };
  }, []);

  const findKeyIgnoreCase = (obj, wantedKey) => {
    if (!obj) return null;
    const lower = wantedKey.toLowerCase();
    const found = Object.keys(obj).find((k) => k.toLowerCase() === lower);
    return found || null;
  };

  const extractHost = (text) => {
    if (!text || typeof text !== "string") return "";
    const ipv4 = text.match(/\b(?:\d{1,3}\.){3}\d{1,3}\b/);
    if (ipv4 && ipv4[0]) return ipv4[0];

    const ipv6 = text.match(/\b([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}\b/);
    if (ipv6 && ipv6[0]) return ipv6[0];

    const hostname = text.match(
      /\b([a-zA-Z0-9][a-zA-Z0-9\-.]{1,}\.[a-zA-Z]{2,}|[a-zA-Z0-9\-.]+(?:\.[a-zA-Z0-9\-.]+)+)\b/
    );
    if (hostname && hostname[0] && !hostname[0].startsWith("-"))
      return hostname[0];

    const tokens = text.split(/\s+/).filter(Boolean);
    for (let i = tokens.length - 1; i >= 0; i--) {
      const t = tokens[i].trim();
      if (!t.startsWith("-") && t.length > 0) {
        const cleaned = t.replace(/[;|&><()]+$/g, "");
        if (cleaned) return cleaned;
      }
    }

    return "";
  };

  const normalizeCommandsValue = (val) => {
    if (!val && val !== "") return [];
    if (Array.isArray(val)) return val.map(String);
    const s = String(val);
    if (s.includes("\n"))
      return s
        .split(/\r?\n/)
        .map((c) => c.trim())
        .filter(Boolean);
    if (s.includes("&&"))
      return s
        .split("&&")
        .map((c) => c.trim())
        .filter(Boolean);
    return [s.trim()].filter(Boolean);
  };

  useEffect(() => {
    let cancelled = false;
    const loadCommands = async () => {
      try {
        const res = await fetch(`${API_BASE}/api/commands`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (cancelled || !mountedRef.current) return;

        const normalized = {};
        Object.entries(data || {}).forEach(([k, v]) => {
          if (typeof v === "string") normalized[k] = { label: k, command: v };
          else if (v && typeof v === "object")
            normalized[k] = { label: v.label || k, command: v.command ?? "" };
          else normalized[k] = { label: k, command: "" };
        });

        const keyFound =
          findKeyIgnoreCase(normalized, preferredKey) ||
          Object.keys(normalized)[0];
        const picked = keyFound ? normalized[keyFound] : { command: "" };
        const raw = picked.command;

        const cmds = normalizeCommandsValue(raw);
        setCommandsList(cmds);
        setCommandStr(cmds.length ? cmds[0] : String(raw || ""));
      } catch (err) {
        console.error("Failed to fetch commands:", err);
        setCommandsList([]);
        setCommandStr("");
      }
    };

    loadCommands();

    return () => {
      cancelled = true;
    };
  }, []);

  const writeAndEmit = (cmd) => {
    try {
      if (window.sharedTerm) {
        window.sharedTerm.write(`\r\n$ ${cmd}\r\n`);
      }
    } catch (e) {
      console.warn("sharedTerm write failed:", e);
    }
    try {
      socket.emit("input", cmd + (cmd.endsWith("\n") ? "" : "\n"));
    } catch (e) {
      console.warn("socket emit failed:", e);
    }
  };

  const replacePlaceholders = (cmd, hostCandidate) => {
    let host = hostCandidate || "";
    if (!host) {
      host = extractHost(commandStr) || "";
    }
    if (!host) {
      host = extractHost(cmd) || "";
    }
    if (!host) return cmd;
    return String(cmd).replace(/\{target\}|\{targetIP\}/g, host);
  };

  const runSequence = (cmds, startIndex = 0) => {
    if (!mountedRef.current) return;
    if (
      !Array.isArray(cmds) ||
      cmds.length === 0 ||
      startIndex >= cmds.length
    ) {
      setLoading(false);
      setProgressIdx(-1);
      timerRef.current = null;
      return;
    }

    const rawCmd = cmds[startIndex];
    const cmdToExecute = replacePlaceholders(rawCmd);

    setCommandStr(cmdToExecute);
    setProgressIdx(startIndex);

    const extracted = extractHost(cmdToExecute);
    console.log(
      `[Malware] executing resolved command: "${cmdToExecute}" - extracted host: "${extracted}"`
    );
    if (extracted) setTargetIP(extracted);

    writeAndEmit(cmdToExecute);

    timerRef.current = setTimeout(() => {
      if (!mountedRef.current) return;
      runSequence(cmds, startIndex + 1);
    }, 5000);
  };

  const handleSelect = (tab) => {
    console.log("Selected tab:", tab);
    if (!tab || !tab.key) return;

    // Send Ctrl+C to terminal before switching
    socket.emit("terminal-cmd", { cmd: "\x03" }); // \x03 is Ctrl+C

    const keyFound = findKeyIgnoreCase(commands, tab.key);
    if (keyFound && commands[keyFound]) {
      let tpl = commands[keyFound].command;
      if (Array.isArray(tpl)) tpl = tpl.join(" && ");
      const resolved = String(tpl).replace(
        /\{target\}|\{targetIP\}/g,
        targetIP || ""
      );
      setCommandStr(resolved);
    }
  };

  const handleAttack = () => {
    let cmdsToRun =
      commandsList && commandsList.length ? [...commandsList] : [];
    if ((!cmdsToRun || cmdsToRun.length === 0) && commandStr.trim()) {
      cmdsToRun = [commandStr.trim()];
    }

    if (!cmdsToRun || cmdsToRun.length === 0) {
      socket.emit("input", "# ❗ No commands available to run.\n");
      return;
    }

    if (loading) return;

    setLoading(true);
    setProgressIdx(0);
    runSequence(cmdsToRun, 0);
  };

  const handleCancel = () => {
    if (timerRef.current) {
      clearTimeout(timerRef.current);
      timerRef.current = null;
    }
    setLoading(false);
    setProgressIdx(-1);
    socket.emit("input", "# Sequence cancelled by user\n");
  };

  console.log("APT : Malware Attack");
  return (
    <Layout style={{ minHeight: "100vh" }}>
      <AppHeader />
      <Layout>
        <Sider>
          <Sidebar />
        </Sider>
        <Layout>
          <Tabs tabs={tabItems} onSelect={handleCancel} />
          <IPPanel targetIP={targetIP} hostOverride="10.229.40.10:5173" />
          <TerminalPanel />
          <Content style={{ marginTop: "1px" }}>
            <div className="terminal-controls" style={{ marginBottom: "16px" }}>
              <input
                type="text"
                placeholder="Command (current from commands.json or edit before run)"
                value={commandStr}
                onChange={(e) => setCommandStr(e.target.value)}
                style={{
                  marginRight: "8px",
                  padding: "4px 8px",
                  width: "250px",
                }}
              />

              {!loading ? (
                <button onClick={handleAttack} style={{ padding: "6px 12px" }}>
                  Malware Attack
                </button>
              ) : (
                <button
                  onClick={handleCancel}
                  style={{
                    padding: "6px 12px",
                    background: "#b91c1c",
                    color: "#fff",
                  }}
                >
                  Cancel ({progressIdx + 1}/{commandsList.length || 1})
                </button>
              )}
            </div>
          </Content>
        </Layout>
      </Layout>
      <Footer className="footer">
        ©2025 Central Research Laboratory. All rights reserved.{" "}
      </Footer>
    </Layout>
  );
};

export default MalwareAttacks;
